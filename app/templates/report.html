{% extends "base.html" %}
{% block title %}Rapport{% endblock %}
{% block content %}
<style>
.dropdown-item small {
    font-size: 0.75em;
    line-height: 1.2;
}

.dropdown-item {
    padding: 0.75rem 1rem;
}

.dropdown-item:hover small {
    color: inherit !important;
}

.btn-group .dropdown-toggle::after {
    margin-left: 0.5em;
}

.alert {
    margin-bottom: 1rem;
}

.spinner-border-sm {
    width: 0.875rem;
    height: 0.875rem;
}
</style>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>Sårbarhetsrapport</h2>
                <div class="btn-group" role="group">
                    <!-- Dropdown för PDF-rapporter -->
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-pdf"></i> Ladda ner PDF
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item pdf-download-btn" href="#" data-report-type="basic">
                                    <i class="bi bi-file-earmark-text"></i> Basic rapport (slutkund)
                                    <small class="text-muted d-block">Enkel översikt med sammanfattning</small>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item pdf-download-btn" href="#" data-report-type="medium">
                                    <i class="bi bi-file-earmark-medical"></i> Medium rapport
                                    <small class="text-muted d-block">Med beskrivningar och konfidensgrad</small>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item pdf-download-btn" href="#" data-report-type="full">
                                    <i class="bi bi-file-earmark-check"></i> Fullständig rapport
                                    <small class="text-muted d-block">Komplett med alla detaljer och URLs</small>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-outline-primary" id="download-report-btn">
                        <i class="bi bi-file-earmark-text"></i> Ladda ner som JSON
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>Målwebbplats: {{ target_url }}</h5>
                    <p>Rapport-ID: {{ report_id }}</p>
                    <p>Genererad: <span id="report-date"></span></p>
                </div>
            <!-- Sammanfattning -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Sammanfattning</h4>
                </div>
                <div class="card-body">
                    {% if debug_mode %}
                    <div class="alert alert-warning">
                        <h4><i class="bi bi-bug"></i> Debug-läge</h4>
                        <div class="mb-2">
                            <strong>Target URL:</strong> {{ target_url }}<br>
                            <strong>Report ID:</strong> {{ report_id }}
                        </div>
                        <div class="mb-2">
                            <button id="debug-api-btn" class="btn btn-sm btn-outline-dark">Testa API-anrop</button>
                            <button id="debug-raw-json-btn" class="btn btn-sm btn-outline-dark">Visa Raw JSON</button>
                        </div>
                        <div id="debug-results" class="mt-2 d-none">
                            <div class="p-2 bg-light overflow-auto" style="max-height: 300px;">
                                <pre id="debug-json"></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-danger text-white mb-3">
                                <div class="card-body text-center">
                                    <h5>Hög risk</h5>
                                    <h2 id="high-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark mb-3">
                                <div class="card-body text-center">
                                    <h5>Medelhög risk</h5>
                                    <h2 id="medium-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white mb-3">
                                <div class="card-body text-center">
                                    <h5>Låg risk</h5>
                                    <h2 id="low-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5>Informativ</h5>
                                    <h2 id="info-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sårbarheter efter risknivå -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Sårbarheter</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" id="alerts-loading">
                        <strong>Laddar sårbarheter...</strong>
                    </div>
                    
                    <div id="alerts-error" class="alert alert-danger d-none">
                        <strong>Fel vid hämtning av sårbarheter!</strong>
                        <span id="alerts-error-message"></span>
                    </div>
                    
                    <div id="no-alerts-message" class="alert alert-success d-none">
                        <strong>Inga sårbarheter hittades.</strong> Bra jobbat!
                    </div>
                    
                    <!-- Accordions för sårbarheter med ny struktur -->
                    <div class="accordion" id="vulnerabilitiesAccordion">
                        <!-- High Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="highRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#highRiskCollapse" aria-expanded="false" aria-controls="highRiskCollapse">
                                    <span class="badge bg-danger me-2">Hög risk</span> Högrisksårbarheter <span class="badge bg-secondary ms-2" id="high-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="highRiskCollapse" class="accordion-collapse collapse" aria-labelledby="highRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="high-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="high-risk-empty" class="alert alert-success d-none">Inga högrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medium Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="mediumRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mediumRiskCollapse" aria-expanded="false" aria-controls="mediumRiskCollapse">
                                    <span class="badge bg-warning text-dark me-2">Medelhög risk</span> Medelrisksårbarheter <span class="badge bg-secondary ms-2" id="medium-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="mediumRiskCollapse" class="accordion-collapse collapse" aria-labelledby="mediumRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="medium-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="medium-risk-empty" class="alert alert-success d-none">Inga medelrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Low Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="lowRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lowRiskCollapse" aria-expanded="false" aria-controls="lowRiskCollapse">
                                    <span class="badge bg-info me-2">Låg risk</span> Lågrisksårbarheter <span class="badge bg-secondary ms-2" id="low-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="lowRiskCollapse" class="accordion-collapse collapse" aria-labelledby="lowRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="low-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="low-risk-empty" class="alert alert-success d-none">Inga lågrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informational Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="infoRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#infoRiskCollapse" aria-expanded="false" aria-controls="infoRiskCollapse">
                                    <span class="badge bg-light text-dark me-2">Informativ</span> Informativa fynd <span class="badge bg-secondary ms-2" id="info-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="infoRiskCollapse" class="accordion-collapse collapse" aria-labelledby="infoRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="info-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="info-risk-empty" class="alert alert-success d-none">Inga informativa fynd hittades.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rekommendationer -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Rekommendationer</h4>
                </div>
                <div class="card-body">
                    <div id="recommendations-container">
                        <!-- Rekommendationer kommer att genereras dynamiskt baserat på resultat -->
                        <p>Laddar rekommendationer...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Modal för sårbarhetsdetaljer -->
<!-- Modal för sårbarhetsdetaljer -->
<div class="modal fade" id="alertDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertDetailsTitle">Sårbarhetsdetaljer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <!-- Beskrivning -->
                <div class="mb-4">
                    <h6 class="fw-bold text-primary">
                        <i class="bi bi-info-circle-fill me-2"></i>Beskrivning
                    </h6>
                    <div id="alert-description" class="p-3 bg-light rounded border"></div>
                </div>
                
                <!-- Risk och Konfidensgrad -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Risk
                            </h6>
                            <div id="alert-risk" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-info">
                                <i class="bi bi-speedometer2 me-2"></i>Konfidensgrad
                            </h6>
                            <div id="alert-confidence" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                
                <!-- URL och Parameter -->
                <div class="mb-4">
                    <h6 class="fw-bold text-dark">
                        <i class="bi bi-link-45deg me-2"></i>URL
                    </h6>
                    <div id="alert-url" class="p-2 bg-light rounded border"></div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-warning">
                                <i class="bi bi-gear-fill me-2"></i>Parameter
                            </h6>
                            <div id="alert-parameter" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-danger">
                                <i class="bi bi-shield-exclamation me-2"></i>Attack
                            </h6>
                            <div id="alert-attack" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Åtgärdsförslag -->
                <div class="mb-4">
                    <h6 class="fw-bold text-success">
                        <i class="bi bi-tools me-2"></i>Åtgärdsförslag
                    </h6>
                    <div id="alert-solution" class="p-3 bg-light rounded border"></div>
                </div>
                
                <!-- Referenser -->
                <div class="mb-4">
                    <h6 class="fw-bold text-info">
                        <i class="bi bi-link-45deg me-2"></i>Referenser & ZAP-länkar
                    </h6>
                    <div id="alert-references" class="p-3 bg-light rounded border"></div>
                </div>
                
                <!-- Teknisk information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-secondary">
                                <i class="bi bi-code-square me-2"></i>CWE (Common Weakness Enumeration)
                            </h6>
                            <div id="alert-cwe" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="fw-bold text-secondary">
                                <i class="bi bi-shield-check me-2"></i>WASC (Web Application Security Consortium)
                            </h6>
                            <div id="alert-wasc" class="p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Taggar -->
                <div class="mb-4">
                    <h6 class="fw-bold text-secondary">
                        <i class="bi bi-tags-fill me-2"></i>Taggar
                    </h6>
                    <div id="alert-tags" class="p-2 bg-light rounded border"></div>
                </div>
                
                <!-- Bevis och Evidence (om tillgängligt) -->
                <div class="mb-4" id="evidence-section" style="display: none;">
                    <h6 class="fw-bold text-warning">
                        <i class="bi bi-file-earmark-text me-2"></i>Bevis/Evidence
                    </h6>
                    <div id="alert-evidence" class="p-3 bg-light rounded border"></div>
                </div>
                
                <!-- Ytterligare teknisk information för teknikern -->
                <div class="accordion" id="technicalAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="technicalHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#technicalCollapse" aria-expanded="false" aria-controls="technicalCollapse">
                                <i class="bi bi-wrench me-2"></i>
                                <strong>Teknisk information för åtgärdande</strong>
                            </button>
                        </h2>
                        <div id="technicalCollapse" class="accordion-collapse collapse" aria-labelledby="technicalHeading" data-bs-parent="#technicalAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Alert ID</h6>
                                        <div id="alert-id" class="p-2 bg-light rounded border mb-3"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Plugin ID</h6>
                                        <div id="alert-plugin-id" class="p-2 bg-light rounded border mb-3"></div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Metod</h6>
                                        <div id="alert-method" class="p-2 bg-light rounded border mb-3"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Input Vector</h6>
                                        <div id="alert-input-vector" class="p-2 bg-light rounded border mb-3"></div>
                                    </div>
                                </div>
                                
                                <h6 class="fw-bold">Request/Response Information</h6>
                                <div id="alert-request-response" class="p-2 bg-light rounded border mb-3"></div>
                                
                                <h6 class="fw-bold">Andra URLs som påverkas</h6>
                                <div id="alert-other-urls" class="p-2 bg-light rounded border"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Stäng
                </button>
                <button type="button" class="btn btn-primary" onclick="copyAlertDetails()">
                    <i class="bi bi-clipboard me-2"></i>Kopiera detaljer
                </button>
                <button type="button" class="btn btn-info" onclick="exportAlertDetails()">
                    <i class="bi bi-download me-2"></i>Exportera
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
<script>
// Template-variabler som JavaScript behöver
document.addEventListener('DOMContentLoaded', function() {
    window.REPORT_CONFIG = {
        target_url: '{{ target_url }}',
        report_id: '{{ report_id }}',
        debug_mode: {{ debug_mode|tojson }}
    };
});
</script>
{% endblock %}