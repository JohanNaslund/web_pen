{% extends "base.html" %}
{% block title %}Rapport{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>Sårbarhetsrapport</h2>
                <button class="btn btn-outline-primary" id="download-report-btn">Ladda ner som JSON</button>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>Målwebbplats: {{ target_url }}</h5>
                    <p>Rapport-ID: {{ report_id }}</p>
                    <p>Genererad: <span id="report-date"></span></p>
                </div>
            <!-- Sammanfattning -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Sammanfattning</h4>
                </div>
                <div class="card-body">
                    {% if debug_mode %}
                    <div class="alert alert-warning">
                        <h4><i class="bi bi-bug"></i> Debug-läge</h4>
                        <div class="mb-2">
                            <strong>Target URL:</strong> {{ target_url }}<br>
                            <strong>Report ID:</strong> {{ report_id }}
                        </div>
                        <div class="mb-2">
                            <button id="debug-api-btn" class="btn btn-sm btn-outline-dark">Testa API-anrop</button>
                            <button id="debug-raw-json-btn" class="btn btn-sm btn-outline-dark">Visa Raw JSON</button>
                        </div>
                        <div id="debug-results" class="mt-2 d-none">
                            <div class="p-2 bg-light overflow-auto" style="max-height: 300px;">
                                <pre id="debug-json"></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-danger text-white mb-3">
                                <div class="card-body text-center">
                                    <h5>Hög risk</h5>
                                    <h2 id="high-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark mb-3">
                                <div class="card-body text-center">
                                    <h5>Medelhög risk</h5>
                                    <h2 id="medium-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white mb-3">
                                <div class="card-body text-center">
                                    <h5>Låg risk</h5>
                                    <h2 id="low-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5>Informativ</h5>
                                    <h2 id="info-risk-count">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sårbarheter efter risknivå -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Sårbarheter</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" id="alerts-loading">
                        <strong>Laddar sårbarheter...</strong>
                    </div>
                    
                    <div id="alerts-error" class="alert alert-danger d-none">
                        <strong>Fel vid hämtning av sårbarheter!</strong>
                        <span id="alerts-error-message"></span>
                    </div>
                    
                    <div id="no-alerts-message" class="alert alert-success d-none">
                        <strong>Inga sårbarheter hittades.</strong> Bra jobbat!
                    </div>
                    
                    <!-- Accordions för sårbarheter med ny struktur -->
                    <div class="accordion" id="vulnerabilitiesAccordion">
                        <!-- High Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="highRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#highRiskCollapse" aria-expanded="false" aria-controls="highRiskCollapse">
                                    <span class="badge bg-danger me-2">Hög risk</span> Högrisksårbarheter <span class="badge bg-secondary ms-2" id="high-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="highRiskCollapse" class="accordion-collapse collapse" aria-labelledby="highRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="high-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="high-risk-empty" class="alert alert-success d-none">Inga högrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medium Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="mediumRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mediumRiskCollapse" aria-expanded="false" aria-controls="mediumRiskCollapse">
                                    <span class="badge bg-warning text-dark me-2">Medelhög risk</span> Medelrisksårbarheter <span class="badge bg-secondary ms-2" id="medium-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="mediumRiskCollapse" class="accordion-collapse collapse" aria-labelledby="mediumRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="medium-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="medium-risk-empty" class="alert alert-success d-none">Inga medelrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Low Risk Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="lowRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lowRiskCollapse" aria-expanded="false" aria-controls="lowRiskCollapse">
                                    <span class="badge bg-info me-2">Låg risk</span> Lågrisksårbarheter <span class="badge bg-secondary ms-2" id="low-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="lowRiskCollapse" class="accordion-collapse collapse" aria-labelledby="lowRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="low-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="low-risk-empty" class="alert alert-success d-none">Inga lågrisksårbarheter hittades.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informational Alerts -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="infoRiskHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#infoRiskCollapse" aria-expanded="false" aria-controls="infoRiskCollapse">
                                    <span class="badge bg-light text-dark me-2">Informativ</span> Informativa fynd <span class="badge bg-secondary ms-2" id="info-risk-badge">0</span>
                                </button>
                            </h2>
                            <div id="infoRiskCollapse" class="accordion-collapse collapse" aria-labelledby="infoRiskHeading" data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <div id="info-risk-types-accordion" class="accordion">
                                        <!-- Alert types will be populated here -->
                                    </div>
                                    <div id="info-risk-empty" class="alert alert-success d-none">Inga informativa fynd hittades.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rekommendationer -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4>Rekommendationer</h4>
                </div>
                <div class="card-body">
                    <div id="recommendations-container">
                        <!-- Rekommendationer kommer att genereras dynamiskt baserat på resultat -->
                        <p>Laddar rekommendationer...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Modal för sårbarhetsdetaljer -->
<div class="modal fade" id="alertDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertDetailsTitle">Sårbarhetsdetaljer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Beskrivning</h6>
                    <div id="alert-description" class="p-2 bg-light"></div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Risk</h6>
                            <div id="alert-risk" class="p-2 bg-light"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Konfidensgrad</h6>
                            <div id="alert-confidence" class="p-2 bg-light"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>URL</h6>
                    <div id="alert-url" class="p-2 bg-light"></div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Parameter</h6>
                            <div id="alert-parameter" class="p-2 bg-light"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Attack</h6>
                            <div id="alert-attack" class="p-2 bg-light"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Åtgärdsförslag</h6>
                    <div id="alert-solution" class="p-2 bg-light"></div>
                </div>
                <div class="mb-3">
                    <h6>Referenser</h6>
                    <div id="alert-references" class="p-2 bg-light"></div>
                </div>
                <!-- Nya fält för detaljerad information -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>CWE</h6>
                            <div id="alert-cwe" class="p-2 bg-light"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>WASC</h6>
                            <div id="alert-wasc" class="p-2 bg-light"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Taggar</h6>
                    <div id="alert-tags" class="p-2 bg-light"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Sätt dagens datum
    document.getElementById('report-date').textContent = new Date().toLocaleString('sv-SE');
    
    // Funktion för att hämta sårbarheter
    function fetchVulnerabilities() {
        // Visa laddningsmeddelande
        document.getElementById('alerts-loading').classList.remove('d-none');
        document.getElementById('alerts-error').classList.add('d-none');
        document.getElementById('no-alerts-message').classList.add('d-none');
        
        // Hämta sårbarheter från API
        fetch('/api/zap-alerts-by-risk')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Dölj laddningsmeddelande
                document.getElementById('alerts-loading').classList.add('d-none');
                
                // Bearbeta och visa data
                processAlertData(data);
            })
            .catch(error => {
                console.error('Error fetching alerts:', error);
                document.getElementById('alerts-loading').classList.add('d-none');
                document.getElementById('alerts-error').classList.remove('d-none');
                document.getElementById('alerts-error-message').textContent = error.message;
            });
    }
    
    // Funktion för att bearbeta och visa sårbarhetsinformation
    function processAlertData(data) {
        // Kontrollera om vi har några sårbarheter
        const hasAlerts = data.alerts_by_risk && 
                        ((data.alerts_by_risk.highAlerts && data.alerts_by_risk.highAlerts.length > 0) || 
                        (data.alerts_by_risk.mediumAlerts && data.alerts_by_risk.mediumAlerts.length > 0) || 
                        (data.alerts_by_risk.lowAlerts && data.alerts_by_risk.lowAlerts.length > 0) || 
                        (data.alerts_by_risk.infoAlerts && data.alerts_by_risk.infoAlerts.length > 0));
        
        if (!hasAlerts) {
            document.getElementById('no-alerts-message').classList.remove('d-none');
            return;
        }
        
        // Uppdatera sammanfattningsräknare från summary
        const summary = data.summary || {};
        document.getElementById('high-risk-count').textContent = summary.High || 0;
        document.getElementById('medium-risk-count').textContent = summary.Medium || 0;
        document.getElementById('low-risk-count').textContent = summary.Low || 0;
        document.getElementById('info-risk-count').textContent = summary.Informational || 0;
        
        // Uppdatera risknivåernas badge-räknare
        document.getElementById('high-risk-badge').textContent = summary.High || 0;
        document.getElementById('medium-risk-badge').textContent = summary.Medium || 0;
        document.getElementById('low-risk-badge').textContent = summary.Low || 0;
        document.getElementById('info-risk-badge').textContent = summary.Informational || 0;
        
        // Fyll i tabellerna för varje risknivå med den nya strukturen
        populateAlertsByType('high', data.alerts_by_risk.highAlerts || []);
        populateAlertsByType('medium', data.alerts_by_risk.mediumAlerts || []);
        populateAlertsByType('low', data.alerts_by_risk.lowAlerts || []);
        populateAlertsByType('info', data.alerts_by_risk.infoAlerts || []);
        
        // Generera rekommendationer baserat på sårbarheter
        generateRecommendations(data);
        
    }
    
    // Ny funktion för att gruppera alerts efter typ och skapa nested accordions
    function populateAlertsByType(riskLevel, alerts) {
        const accordionId = `${riskLevel}-risk-types-accordion`;
        const emptyMessageId = `${riskLevel}-risk-empty`;
        const accordionContainer = document.getElementById(accordionId);
        
        // Rensa containern
        accordionContainer.innerHTML = '';
        
        if (!alerts || alerts.length === 0) {
            document.getElementById(emptyMessageId).classList.remove('d-none');
            return;
        }
        
        document.getElementById(emptyMessageId).classList.add('d-none');
        
        // Gruppera alerts efter namn
        const alertsByType = {};
        alerts.forEach(alert => {
            const alertName = alert.name || 'Okänd alert';
            if (!alertsByType[alertName]) {
                alertsByType[alertName] = [];
            }
            alertsByType[alertName].push(alert);
        });
        
        
        // Skapa accordion items för varje alert-typ
        Object.keys(alertsByType).forEach((alertName, index) => {
            const typeAlerts = alertsByType[alertName];
            const typeId = `${riskLevel}-type-${index}`;
            const headingId = `${typeId}-heading`;
            const collapseId = `${typeId}-collapse`;
            
            // Skapa accordion item för denna alert-typ
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            
            accordionItem.innerHTML = `
                <h3 class="accordion-header" id="${headingId}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                        <span class="badge bg-primary me-2">${typeAlerts.length}</span> ${escapeHtml(alertName)}
                    </button>
                </h3>
                <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#${accordionId}">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Parameter</th>
                                        <th>CWE</th>
                                        <th>Konfidensgrad</th>
                                        <th>Detaljer</th>
                                    </tr>
                                </thead>
                                <tbody id="${typeId}-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            accordionContainer.appendChild(accordionItem);
            
            // Fyll i tabellen för denna alert-typ
            const tbody = document.getElementById(`${typeId}-tbody`);
            typeAlerts.forEach(alert => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div class="text-truncate" style="max-width: 300px;" title="${escapeHtml(alert.url || 'N/A')}">
                            ${shortenUrl(alert.url) || 'N/A'}
                        </div>
                    </td>
                    <td>${escapeHtml(alert.param || 'N/A')}</td>
                    <td>${escapeHtml(alert.cweid || 'N/A')}</td>
                    <td>
                        <span class="badge ${getConfidenceBadgeClass(alert.confidence)}">
                            ${escapeHtml(alert.confidence || 'N/A')}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info view-details-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#alertDetailsModal"
                            data-alert-id="${alert.id}">
                            Visa detaljer
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        });
        
        // Lägg till event listeners för de nya knapparna
        addViewDetailsListeners();
    }
    
    // Hjälpfunktion för att få konfidensgrads-badge-klass
    function getConfidenceBadgeClass(confidence) {
        if (!confidence) return 'bg-secondary';
        
        const conf = confidence.toLowerCase();
        if (conf === 'high') return 'bg-success';
        if (conf === 'medium') return 'bg-warning';
        if (conf === 'low') return 'bg-danger';
        return 'bg-info';
    }
    
    // Funktion för att lägga till event listeners för detalj-knappar
    function addViewDetailsListeners() {
        document.querySelectorAll('.view-details-btn').forEach(button => {
            button.addEventListener('click', function() {
                const alertId = this.getAttribute('data-alert-id');
                showAlertDetails(alertId);
            });
        });
    }
    
    // Funktion för att visa alert-detaljer
    function showAlertDetails(alertId) {
        const loadingHtml = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laddar...</span></div><p>Hämtar detaljerad information...</p></div>';
        
        // Visa laddningsindikator
        document.getElementById('alertDetailsTitle').textContent = "Laddar detaljer...";
        document.getElementById('alert-description').innerHTML = loadingHtml;
        document.getElementById('alert-risk').innerHTML = "";
        document.getElementById('alert-confidence').innerHTML = "";
        document.getElementById('alert-url').innerHTML = "";
        document.getElementById('alert-parameter').innerHTML = "";
        document.getElementById('alert-attack').innerHTML = "";
        document.getElementById('alert-solution').innerHTML = "";
        document.getElementById('alert-references').innerHTML = "";
        
        // Hämta detaljerad information från ZAP API
        fetch(`/api/alert-details/${alertId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error fetching alert details:", data.error);
                    document.getElementById('alertDetailsTitle').textContent = "Fel vid hämtning";
                    document.getElementById('alert-description').textContent = `Ett fel uppstod: ${data.error}`;
                    return;
                }
                
                const alert = data.alert;
                
                // Fyll i modalfönstret med alertdetaljer
                document.getElementById('alertDetailsTitle').textContent = alert.name || "Okänd alert";
                document.getElementById('alert-description').textContent = alert.description || "Ingen beskrivning tillgänglig";
                document.getElementById('alert-risk').textContent = alert.risk || "N/A";
                document.getElementById('alert-confidence').textContent = alert.confidence || "N/A";
                document.getElementById('alert-url').textContent = alert.url || "N/A";
                document.getElementById('alert-parameter').textContent = alert.param || "N/A";
                document.getElementById('alert-attack').textContent = alert.attack || "N/A";
                document.getElementById('alert-solution').textContent = alert.solution || "N/A";
                
                // Hantera referenser som länkar
                let referencesHTML = '';
                if (alert.reference) {
                    const refs = alert.reference.split('\n');
                    refs.forEach(ref => {
                        if (ref.trim()) {
                            if (ref.startsWith('http')) {
                                referencesHTML += `<a href="${ref}" target="_blank">${ref}</a><br>`;
                            } else {
                                referencesHTML += `${ref}<br>`;
                            }
                        }
                    });
                }
                document.getElementById('alert-references').innerHTML = referencesHTML || 'N/A';
                
                // Visa CWE-information om tillgänglig
                if (alert.cweid) {
                    const cweElement = document.getElementById('alert-cwe');
                    if (cweElement) {
                        cweElement.textContent = `CWE-${alert.cweid}`;
                    }
                }
                
                // Visa WASCID-information om tillgänglig
                if (alert.wascid) {
                    const wascElement = document.getElementById('alert-wasc');
                    if (wascElement) {
                        wascElement.textContent = `WASC-${alert.wascid}`;
                    }
                }
                
                // Visa eventuella taggar
                if (alert.tags && Object.keys(alert.tags).length > 0) {
                    const tagsElement = document.getElementById('alert-tags');
                    if (tagsElement) {
                        let tagsHTML = '';
                        for (const [key, value] of Object.entries(alert.tags)) {
                            tagsHTML += `<span class="badge bg-info me-1">${key}</span>`;
                        }
                        tagsElement.innerHTML = tagsHTML;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching alert details:', error);
                document.getElementById('alertDetailsTitle').textContent = "Fel vid hämtning";
                document.getElementById('alert-description').textContent = `Ett fel uppstod: ${error.message}`;
            });
    }
    
    // Funktion för att förkorta URL:er för bättre visning
    function shortenUrl(url) {
        if (!url) return '';
        
        // Begränsa URL:en till 50 tecken med ellips
        if (url.length > 50) {
            return url.substring(0, 47) + '...';
        }
        return url;
    }
    
    // Hjälpfunktion för att säkert escapea HTML
    function escapeHtml(text) {
        if (text === null || text === undefined) return 'N/A';
        
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        
        return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Funktion för att generera rekommendationer
    function generateRecommendations(data) {
        const recommendationsContainer = document.getElementById('recommendations-container');
        const alerts = data.alerts_by_risk || {};
        
        // Rensa behållaren
        recommendationsContainer.innerHTML = '';
        
        const hasHighAlerts = alerts.highAlerts && alerts.highAlerts.length > 0;
        const hasMediumAlerts = alerts.mediumAlerts && alerts.mediumAlerts.length > 0;
        const hasLowAlerts = alerts.lowAlerts && alerts.lowAlerts.length > 0;
        
        if (!hasHighAlerts && !hasMediumAlerts && !hasLowAlerts) {
            recommendationsContainer.innerHTML = `
                <div class="alert alert-success">
                    <strong>Bra jobb!</strong> Inga kritiska sårbarheter hittades. Fortsätt med regelbundna säkerhetstester.
                </div>
            `;
            return;
        }
        
        // Skapa prioriterad lista över rekommendationer
        let prioritizedRecommendations = [];
        
        // Bearbeta sårbarheter för rekommendationer
        if (hasHighAlerts) {
            const xssVulnerabilities = alerts.highAlerts.filter(alert => 
                alert.name.toLowerCase().includes('cross site scripting') ||
                alert.name.toLowerCase().includes('xss')
            );
            
            const sqlVulnerabilities = alerts.highAlerts.filter(alert => 
                alert.name.toLowerCase().includes('sql injection')
            );
            
            const rceVulnerabilities = alerts.highAlerts.filter(alert => 
                alert.name.toLowerCase().includes('remote code execution') ||
                alert.name.toLowerCase().includes('command injection')
            );
            
            if (xssVulnerabilities.length > 0) {
                prioritizedRecommendations.push({
                    title: 'Åtgärda Cross-Site Scripting (XSS)',
                    description: 'Implementera striktare indata-validering och utdatakodning för att förhindra XSS-attacker. Använd ett säkerhetsbibliotek och validera all användarinmatning.',
                    priority: 'high',
                    count: xssVulnerabilities.length
                });
            }
            
            if (sqlVulnerabilities.length > 0) {
                prioritizedRecommendations.push({
                    title: 'Åtgärda SQL-injektionssårbarheter',
                    description: 'Använd parametriserade frågor eller prepared statements för alla databasinteraktioner. Undvik att bygga SQL-frågor genom konkatenering.',
                    priority: 'high',
                    count: sqlVulnerabilities.length
                });
            }
            
            if (rceVulnerabilities.length > 0) {
                prioritizedRecommendations.push({
                    title: 'Åtgärda Command Injection-sårbarheter',
                    description: 'Validera noggrant all användarindata och undvik att skicka osäkra data till systemkommandon. Använd whitelisting för tillåtna kommandon.',
                    priority: 'high',
                    count: rceVulnerabilities.length
                });
            }
        }
        
        if (hasMediumAlerts) {
            const csrfVulnerabilities = alerts.mediumAlerts.filter(alert => 
                alert.name.toLowerCase().includes('csrf') ||
                alert.name.toLowerCase().includes('cross-site request forgery')
            );
            
            const headerVulnerabilities = alerts.mediumAlerts.filter(alert => 
                alert.name.toLowerCase().includes('header') ||
                alert.name.toLowerCase().includes('clickjacking') ||
                alert.name.toLowerCase().includes('x-frame-options')
            );
            
            if (csrfVulnerabilities.length > 0) {
                prioritizedRecommendations.push({
                    title: 'Implementera CSRF-skydd',
                    description: 'Lägg till CSRF-tokens för alla formulär och tillståndsändrande operationer. Kontrollera referer-header och använd SameSite cookies.',
                    priority: 'medium',
                    count: csrfVulnerabilities.length
                });
            }
            
            if (headerVulnerabilities.length > 0) {
                prioritizedRecommendations.push({
                    title: 'Förbättra HTTP-säkerhetshuvuden',
                    description: 'Implementera säkerhetshuvuden som Content-Security-Policy, X-Frame-Options och X-XSS-Protection för att förhindra vanliga webbattacker.',
                    priority: 'medium',
                    count: headerVulnerabilities.length
                });
            }
        }
        
        // Lägg till generella rekommendationer
        prioritizedRecommendations.push({
            title: 'Regelbunden säkerhetstestning',
            description: 'Genomför regelbundna sårbarhetsscans för att identifiera nya säkerhetsproblem i applikationen.',
            priority: 'low'
        });
        
        prioritizedRecommendations.push({
            title: 'Implementera säker utvecklingsprocess',
            description: 'Utbilda utvecklare i säker kodning och implementera säkerhetsgranskningar i utvecklingsprocessen.',
            priority: 'low'
        });
        
        // Visa rekommendationer
        let recommendationsHTML = `<ul class="list-group">`;
        
        prioritizedRecommendations.forEach(rec => {
            const priorityClass = rec.priority === 'high' ? 'list-group-item-danger' : 
                                  (rec.priority === 'medium' ? 'list-group-item-warning' : 'list-group-item-info');
            
            const countBadge = rec.count ? `<span class="badge bg-secondary">${rec.count}</span>` : '';
            
            recommendationsHTML += `
                <li class="list-group-item ${priorityClass}">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${rec.title} ${countBadge}</h5>
                        <small>${rec.priority.charAt(0).toUpperCase() + rec.priority.slice(1)} prioritet</small>
                    </div>
                    <p class="mb-1">${rec.description}</p>
                </li>
            `;
        });
        
        recommendationsHTML += `</ul>`;
        recommendationsContainer.innerHTML = recommendationsHTML;
    }
    
    // Hantera nedladdning av rapport
    document.getElementById('download-report-btn').addEventListener('click', function() {
        fetch('/api/download-report/{{ report_id }}')
            .then(response => response.json())
            .then(data => {
                // Skapa en JSON-fil för nedladdning
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `pentesting_report_${data.id || '{{ report_id }}'}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            })
            .catch(error => {
                console.error('Error downloading report:', error);
                alert('Kunde inte hämta rapporten. Vänligen försök igen.');
            });
    });
    
    // Initiera hämtning av sårbarheter när sidan laddas
    fetchVulnerabilities();
});
</script>
{% if debug_mode %}
<script>
// Debug-knappar
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('debug-api-btn')) {
        document.getElementById('debug-api-btn').addEventListener('click', function() {
            fetch('/api/zap-alerts-by-risk')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('debug-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('debug-results').classList.remove('d-none');
                })
                .catch(error => {
                    document.getElementById('debug-json').textContent = 'Error: ' + error.message;
                    document.getElementById('debug-results').classList.remove('d-none');
                });
        });
    }
    
    if (document.getElementById('debug-raw-json-btn')) {
        document.getElementById('debug-raw-json-btn').addEventListener('click', function() {
            fetch('/debug-zap-api')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('debug-json').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('debug-results').classList.remove('d-none');
                })
                .catch(error => {
                    document.getElementById('debug-json').textContent = 'Error: ' + error.message;
                    document.getElementById('debug-results').classList.remove('d-none');
                });
        });
    }
    
    // Logga extra information i konsolen
    console.info('Debug mode enabled');
    console.info('Target URL:', '{{ target_url }}');
    console.info('Report ID:', '{{ report_id }}');
});
</script>
{% endif %}
{% endblock %}