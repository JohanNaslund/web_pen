<!-- Uppdaterad access_control.html - ers칛tt den befintliga -->
{% extends "base.html" %}
{% block title %}Access Control Testing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h2>Access Control Testing</h2>
            </div>
            <div class="card-body">
                {% if target_url %}
                <div class="alert alert-info">
                    <h5>Testa f칬r datal칛ckage mellan anv칛ndarniv친er</h5>
                    <p><strong>M친lwebbplats:</strong> <code>{{ target_url }}</code></p>
                    <p>Detta verktyg hj칛lper dig att identifiera om olika anv칛ndarniv친er kan komma 친t varandras data eller funktionalitet.</p>
                    <div class="mt-2">
                        <strong>S친 h칛r fungerar det:</strong>
                        <ol class="mt-2">
                            <li>Nollst칛ll ZAP f칬r ren testmilj칬</li>
                            <li>Logga in som f칬rsta anv칛ndare (t.ex. admin) och samla URL:er</li>
                            <li>Logga in som andra anv칛ndare (t.ex. normal user) och samla URL:er</li>
                            <li>Testa om normal user kan komma 친t admin-URL:er med sina credentials</li>
                        </ol>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <h5>Ingen m친lwebbplats konfigurerad</h5>
                    <p>Du beh칬ver f칬rst konfigurera en m친lwebbplats f칬r att kunna utf칬ra access control testing.</p>
                    <a href="{{ url_for('target') }}" class="btn btn-primary">G친 till m친lkonfiguration</a>
                </div>
                {% endif %}
                
                <!-- Steg 1: Reset ZAP -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Steg 1: F칬rbered testning</h5>
                    </div>
                    <div class="card-body">
                        <p>B칬rja med att nollst칛lla ZAP f칬r att s칛kerst칛lla ren testmilj칬.</p>
                        <button id="reset-zap-btn" class="btn btn-warning" {% if not target_url %}disabled{% endif %}>
                            <i class="bi bi-arrow-clockwise"></i> Nollst칛ll ZAP f칬r Access Control Testing
                        </button>
                        {% if not target_url %}
                        <div class="form-text text-muted">Konfigurera m친lwebbplats f칬rst f칬r att aktivera denna funktion</div>
                        {% endif %}
                        <div id="reset-status" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Steg 2: Samla URLs -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Steg 2: Samla URL:er fr친n olika anv칛ndarsessioner</h5>
                    </div>
                    <div class="card-body">
                        <p>Logga in som olika anv칛ndare och samla URL:er de har 친tkomst till.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="target-url" class="form-label">Target URL</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="target-url" 
                                           value="{{ target_url or '' }}" 
                                           {% if target_url %}{% else %}placeholder="https://example.com"{% endif %}>
                                    {% if not target_url %}
                                    <button class="btn btn-outline-secondary" type="button" id="set-target-btn">
                                        <i class="bi bi-check"></i> S칛tt
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="form-text">
                                    {% if target_url %}
                                    M친lwebbplats 칛r konfigurerad fr친n huvudinst칛llningar
                                    {% else %}
                                    Ange URL till applikationen som ska testas
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="session-label" class="form-label">Sessionsetikett</label>
                                <input type="text" class="form-control" id="session-label" placeholder="admin">
                                <div class="form-text">Beskrivande namn (t.ex. "admin", "user", "guest", "manager")</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="collect-urls-btn" class="btn btn-primary" {% if not target_url %}disabled{% endif %}>
                                <i class="bi bi-collection"></i> Samla URL:er fr친n nuvarande ZAP-session
                            </button>
                            <div class="form-text mt-1">
                                <strong>Instruktion:</strong> Innan du klickar, surfa runt p친 webbapplikationen via ZAP proxy med den anv칛ndare du vill testa (t.ex. logga in som admin och bes칬k admin-sidor).
                            </div>
                        </div>
                        
                        <div id="collection-status" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Steg 3: Visa insamlade sessioner -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Steg 3: Insamlade sessioner</h5>
                        <button id="refresh-sessions-btn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Uppdatera
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sessions-list">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Laddar sessioner...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Steg 4: Testa Access Control -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Steg 4: Testa Access Control</h5>
                    </div>
                    <div class="card-body">
                        <p>V칛lj en session med URL:er att testa och ange credentials f칬r anv칛ndaren som ska f칬rs칬ka komma 친t dessa URL:er.</p>
                        
                        {% if target_url %}
                        <div class="alert alert-info">
                            <small><strong>Tips:</strong> Testa om en "normal user" kan komma 친t "admin"-URL:er genom att v칛lja admin-sessionen som k칛lla och extrahera cookies fr친n en inloggad normal user.</small>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-4">
                                <label for="source-session-select" class="form-label">K칛ll-session (URL:er att testa)</label>
                                <select class="form-select" id="source-session-select" {% if not target_url %}disabled{% endif %}>
                                    <option value="">V칛lj session...</option>
                                </select>
                                <div class="form-text">V칛lj session med URL:er som ska testas</div>
                            </div>
                            <div class="col-md-4">
                                <label for="test-cookies" class="form-label">Test-cookies</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="test-cookies" 
                                           placeholder="sessionid=abc123; csrftoken=def456" 
                                           {% if not target_url %}disabled{% endif %}>
                                    <button class="btn btn-outline-secondary" type="button" id="extract-cookies-btn" 
                                            {% if not target_url %}disabled{% endif %}>
                                        <i class="bi bi-download"></i> Extrahera fr친n ZAP
                                    </button>
                                </div>
                                <div class="form-text">Cookies f칬r anv칛ndaren som ska testa 친tkomst</div>
                            </div>
                            <div class="col-md-4">
                                <label for="test-label" class="form-label">Test-etikett</label>
                                <input type="text" class="form-control" id="test-label" 
                                       placeholder="normal_user" {% if not target_url %}disabled{% endif %}>
                                <div class="form-text">Beskrivande namn f칬r testanv칛ndaren</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="start-test-btn" class="btn btn-danger" {% if not target_url %}disabled{% endif %}>
                                <i class="bi bi-shield-exclamation"></i> Starta Access Control Test
                            </button>
                            <div class="form-text mt-1">
                                <strong>Varning:</strong> Detta kommer att testa alla URL:er fr친n k칛ll-sessionen med test-anv칛ndarens credentials.
                            </div>
                        </div>
                        
                        <div id="test-status" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Steg 5: Resultat -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Testresultat</h5>
                        <button id="refresh-results-btn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Uppdatera
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span>Inga testresultat 칛nnu. K칬r ett access control test f칬r att se resultat h칛r.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hj칛lp-sektion - endast visa om target_url finns -->
                {% if target_url %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Workflow f칬r {{ target_url }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>游녬 Admin Session</h6>
                                <ol>
                                    <li>칐ppna webbl칛sare med ZAP proxy</li>
                                    <li>G친 till <code>{{ target_url }}</code></li>
                                    <li>Logga in som <strong>administrator</strong></li>
                                    <li>Surfa p친 admin-funktioner (dashboards, inst칛llningar, anv칛ndarhantering)</li>
                                    <li>Skriv "Admin" i sessionsetikett</li>
                                    <li>Klicka "Samla URL:er"</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>游녻 Normal User Session</h6>
                                <ol>
                                    <li>Logga ut fr친n admin</li>
                                    <li>Logga in som <strong>vanlig anv칛ndare</strong></li>
                                    <li>Surfa p친 normala funktioner (profil, anv칛ndarfunktioner)</li>
                                    <li>Skriv "NormalUser" i sessionsetikett</li>
                                    <li>Klicka "Samla URL:er"</li>
                                    <li><strong>Testa:</strong> V칛lj "Admin" som k칛lla, extrahera cookies fr친n normal user</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/access_control.js') }}"></script>
<script>
// L칛gg till funktion f칬r att s칛tta target URL manuellt
document.addEventListener('DOMContentLoaded', function() {
    const setTargetBtn = document.getElementById('set-target-btn');
    const targetUrlInput = document.getElementById('target-url');
    
    if (setTargetBtn) {
        setTargetBtn.addEventListener('click', function() {
            const targetUrl = targetUrlInput.value.trim();
            
            if (!targetUrl) {
                alert('Ange en target URL f칬rst');
                return;
            }
            
            setTargetBtn.disabled = true;
            setTargetBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> S칛tter...';
            
            fetch('/api/access-control/set-target', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    target_url: targetUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Target URL satt till: ${data.target_url}`);
                    location.reload(); // Ladda om sidan f칬r att aktivera funktioner
                } else {
                    alert(`Fel: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Fel: ${error.message}`);
            })
            .finally(() => {
                setTargetBtn.disabled = false;
                setTargetBtn.innerHTML = '<i class="bi bi-check"></i> S칛tt';
            });
        });
    }
});
</script>
{% endblock %}